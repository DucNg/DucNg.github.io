<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Creating an encrypted RAID5 on Linux using mdadm, LUKS and LVM | Duc Nguyen</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Having a bunch of unused 1 To HDD and my NAS getting full I decided to take extra steps ensuring my data were safe.
Stuff I already had Custom NAS running Arch Linux (just an old PC) with 2*1 To HDD 2 unused 1 To HDD The idea Having 4 1 To HDD I could potentialy create a RAID 5 with 3 To of usable space ensuring my data were a little more safe."><meta name=generator content="Hugo 0.111.3"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link href=/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css rel=stylesheet><meta property="og:title" content="Creating an encrypted RAID5 on Linux using mdadm, LUKS and LVM"><meta property="og:description" content="Having a bunch of unused 1 To HDD and my NAS getting full I decided to take extra steps ensuring my data were safe.
Stuff I already had Custom NAS running Arch Linux (just an old PC) with 2*1 To HDD 2 unused 1 To HDD The idea Having 4 1 To HDD I could potentialy create a RAID 5 with 3 To of usable space ensuring my data were a little more safe."><meta property="og:type" content="article"><meta property="og:url" content="https://ducng.github.io/posts/raid5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-20T18:31:00+01:00"><meta property="article:modified_time" content="2022-01-20T18:31:00+01:00"><meta itemprop=name content="Creating an encrypted RAID5 on Linux using mdadm, LUKS and LVM"><meta itemprop=description content="Having a bunch of unused 1 To HDD and my NAS getting full I decided to take extra steps ensuring my data were safe.
Stuff I already had Custom NAS running Arch Linux (just an old PC) with 2*1 To HDD 2 unused 1 To HDD The idea Having 4 1 To HDD I could potentialy create a RAID 5 with 3 To of usable space ensuring my data were a little more safe."><meta itemprop=datePublished content="2022-01-20T18:31:00+01:00"><meta itemprop=dateModified content="2022-01-20T18:31:00+01:00"><meta itemprop=wordCount content="863"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating an encrypted RAID5 on Linux using mdadm, LUKS and LVM"><meta name=twitter:description content="Having a bunch of unused 1 To HDD and my NAS getting full I decided to take extra steps ensuring my data were safe.
Stuff I already had Custom NAS running Arch Linux (just an old PC) with 2*1 To HDD 2 unused 1 To HDD The idea Having 4 1 To HDD I could potentialy create a RAID 5 with 3 To of usable space ensuring my data were a little more safe."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Duc Nguyen</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/contact/ title="Contact page">Contact</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Posts page">Posts</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/projects/ title="Projects page">Projects</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/cv/ title="Resume page">Resume</a></li></ul><a href=https://www.linkedin.com/in/nguyen-d/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/DucNg/ target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://ducng.github.io/index.xml target=_blank class="link-transition rss link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="RSS——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw9 center ph5"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://ducng.github.io/posts/raid5/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://ducng.github.io/posts/raid5/&amp;text=Creating%20an%20encrypted%20RAID5%20on%20Linux%20using%20mdadm,%20LUKS%20and%20LVM" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ducng.github.io/posts/raid5/&amp;title=Creating%20an%20encrypted%20RAID5%20on%20Linux%20using%20mdadm,%20LUKS%20and%20LVM" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Creating an encrypted RAID5 on Linux using mdadm, LUKS and LVM</h1><time class="f6 mv4 dib tracked" datetime=2022-01-20T18:31:00+01:00>January 20, 2022</time></header><div class="nested-copy-line-height lh-copy Avenir bg-near-white tj f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Having a bunch of unused 1 To HDD and my NAS getting full I decided to take extra steps ensuring my data were safe.</p><h2 id=stuff-i-already-had>Stuff I already had</h2><ul><li>Custom NAS running Arch Linux (just an old PC) with 2*1 To HDD</li><li>2 unused 1 To HDD</li></ul><h2 id=the-idea>The idea</h2><p>Having 4 1 To HDD I could potentialy create a RAID 5 with 3 To of usable space ensuring my data were a little more safe.</p><p>The problem was that I needed to backup all the stuff from the 4 HDD before doing anything. So I brough a brand new 3 To HDD just to do that.</p><p>The new drive will serve 2 purposes: backup everything to allow creation of the RAID5 and having a cold backup in case of RAID failure (or unwanted rm -rf).</p><h2 id=first-step-backup>First step: backup</h2><p>First step was to backup everything in the same place: the new 3 To HDD. It&rsquo;s a long a tedious task considering I had a lot of duplicates datas in different places. Using rsync helps a bit.</p><p>To backup the existing NAS I used the -a option in rsync that keeps files ownerships and rights and also copy symlinks. Using this command I could backup the entire Linux system and save time not having to reinstall everything.</p><p>From an ArchLinux live ISO on the NAS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Partition the new 3 To HDD</span>
</span></span><span style=display:flex><span>cfdisk /dev/sdX
</span></span><span style=display:flex><span><span style=color:#75715e># Format the new 3 To HDD to ext4</span>
</span></span><span style=display:flex><span>mkfs.ext4 /dev/sdX1
</span></span><span style=display:flex><span><span style=color:#75715e># Mount the new disk</span>
</span></span><span style=display:flex><span>mkdir /mnt/backup
</span></span><span style=display:flex><span>mount /dev/sdX1 /mnt/backup
</span></span><span style=display:flex><span><span style=color:#75715e># Mount the 2 existing disks</span>
</span></span><span style=display:flex><span>mkdir /mnt/old_system
</span></span><span style=display:flex><span>mount /dev/sdY /mnt/old_system
</span></span><span style=display:flex><span>mount /dev/sdZ /mnt/old_system/&lt;mount_point&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># Backup everything</span>
</span></span><span style=display:flex><span>rsync --progress -a /mnt/old_system /mnt/backup
</span></span></code></pre></div><p>Backuping the 2 other drives was mostly a similar process except I ensured using the -u to avoid copying existing data.</p><h2 id=second-step-creating-the-raid>Second step: Creating the RAID</h2><p>Connect the 5 drives to the NAS. Considering my old 1 To drives are /dev/sda, /dev/sdb, /dev/sdc, /dev/sdd and the the 3 To HDD is /dev/sde</p><p>Create a single partition on each drives leaving about 100 Mo of free space at the end in case every drive don&rsquo;t have the exact same size.
The goal is to have partitions of the exact same size even if there is some empty space.</p><p>Set every drives to GPT and partition type to Linux RAID</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cfdisk -z /dev/sda
</span></span><span style=display:flex><span>cfdisk -z /dev/sdb
</span></span><span style=display:flex><span>cfdisk -z /dev/sdc
</span></span><span style=display:flex><span>cfdisk -z /dev/sdd
</span></span></code></pre></div><p>Then we can processed creating the RAID</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mdadm --create --verbose --level <span style=color:#ae81ff>5</span> --raid-devices<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> /dev/md/&lt;RAID NAME&gt; /dev/sda1 /dev/sdb1 /dev/sdc1 /dev/sdd1
</span></span></code></pre></div><p>We can now encrypt the whole RAID.</p><h3 id=encrypting-the-raid-using-luks>Encrypting the RAID using LUKS</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cryptsetup luksFormat /dev/md/&lt;RAID NAME&gt;
</span></span></code></pre></div><p>Open the LUKS volume</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cryptsetup open /dev/md/&lt;RAID NAME&gt; cryptroot
</span></span></code></pre></div><p>We now have this 3 To block device: /dev/mapper/cryptroot</p><p>If we want to create partitions the usual way won&rsquo;t work since we only have access to a single encrypted block device.
What we can use however is logical volume management, namely LVM.</p><h3 id=partition-the-raid-using-lvm>Partition the RAID using LVM</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pvcreate /dev/mapper/cryptroot
</span></span><span style=display:flex><span>vgcreate volgroup /dev/mapper/cyptroot
</span></span><span style=display:flex><span>lvcreate -L 20G volgroup -n root
</span></span><span style=display:flex><span>lvcreate -L 2G volgroup -n swap
</span></span><span style=display:flex><span>lvcreate -l +100%FREE volgroup -n home
</span></span></code></pre></div><p>Format every partitions</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkfs.ext4 -L root /dev/mapper/volgroup-root
</span></span><span style=display:flex><span>mkfs.ext4 -L home /dev/mapper/volgroup-home
</span></span><span style=display:flex><span>mkswap /dev/mapper/volgroup-swap
</span></span></code></pre></div><p>Mount everything</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mount /dev/mapper/volgroup-root /mnt
</span></span><span style=display:flex><span>mkdir /mnt/home
</span></span><span style=display:flex><span>mount /dev/mapper/volgroup-home /mnt/home
</span></span><span style=display:flex><span>swapon /dev/mapper/volgroup-swap
</span></span></code></pre></div><h3 id=install-linux>Install Linux</h3><p>For me it&rsquo;s as easy as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mount /dev/sde /media
</span></span><span style=display:flex><span>rsync --progress -a /dev/media /mnt
</span></span></code></pre></div><p>Let Linux magic happen&mldr;</p><p>Create fstab and mdadm.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>genfstab -U /mnt &gt; /mnt/etc/fstab
</span></span><span style=display:flex><span>mdadm --detail --scan &gt;&gt; /etc/mdadm.conf
</span></span></code></pre></div><h2 id=thrid-step-get-linux-to-boot>Thrid step: get Linux to boot</h2><p>At this point my Linux is basically ready to rock (we have a fully usable chroot system). Except for one thing: I cannot boot into it.</p><p>Getting it to boot is no easy task: there is no way my BIOS is able to boot into the RAID directly.
The only thing my BIOS is capable of booting is single simple MBR device.
Since all my SATA ports were already used for the RAID, my only option was to use an old USB drive and install grub on it. Plug it in: /dev/sdf</p><h3 id=prepare-the-usb-stick>Prepare the USB stick</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cfdisk -z /dev/sdf <span style=color:#75715e># make sure it&#39;s MBR</span>
</span></span><span style=display:flex><span>mkfs.ext4 -L boot /dev/sdf1
</span></span><span style=display:flex><span>rm -rf /mnt/boot/* <span style=color:#75715e># remove previous GRUB installation</span>
</span></span><span style=display:flex><span>mount /dev/sdf1 /mnt/boot
</span></span><span style=display:flex><span>arch-chroot /mnt <span style=color:#75715e># at this point we can chroot onto the new system</span>
</span></span><span style=display:flex><span>grub-install --target<span style=color:#f92672>=</span>i386-pc /dev/sdf <span style=color:#75715e># install grub on the USB stick</span>
</span></span></code></pre></div><h3 id=add-needed-hooks-to-initramfs>Add needed hooks to initramfs</h3><p>Edit HOOKS in /etc/mkinitcpio.conf: insert mdadm_udev, encrypt, lvm2 between block and filesystems:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>HOOKS<span style=color:#f92672>=(</span>base udev ... block mdadm_udev encrypt lvm2 filesystems<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Build initramfs onto the USB stick:</p><pre tabindex=0><code>mkinitcpio -P
</code></pre><h3 id=configure-grub>Configure GRUB</h3><p>We want boot to happen in a very specific way since it needs to: assemble the RAID, open the LUKS volume and detect my LVM volume group. In this specific order.</p><p>GRUB helps a lot getting everything to work properly. The only thing you need is to edit GRUB_CMDLINE_LINUX in /etc/default/grub</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>GRUB_CMDLINE_LINUX<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cryptdevice=/dev/md/&lt;RAID NAME&gt;:cryptroot root=/dev/mapper/volgroup-root&#34;</span>
</span></span></code></pre></div><p>The root= parameter specifies the device of the actual (decrypted) root file system, the cryptdevice= parameter make the system prompt for the passphrase to unlock the device containing the encrypted root.</p><p>Create grub config file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>Thanks to GRUB everything should work now. Change BIOS options to boot on the USB stick and we&rsquo;re good to go.</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://ducng.github.io/>&copy; Duc Nguyen 2023</a><div><a href=https://www.linkedin.com/in/nguyen-d/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/DucNg/ target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://ducng.github.io/index.xml target=_blank class="link-transition rss link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="RSS——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></footer><script src=/dist/js/app.3fc0f988d21662902933.js></script></body></html>